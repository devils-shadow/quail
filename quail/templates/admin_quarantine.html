{% extends "layout.html" %}
{% block content %}
<div class="page-header">
  <div>
    <h1 class="page-title">Quarantine</h1>
    <p class="row-muted">Admin-only view of quarantined messages.</p>
  </div>
  <div class="toolbar">
    <a class="button secondary" href="/inbox">Inbox</a>
    <a class="button secondary" href="/admin/settings">Settings</a>
  </div>
</div>

{% if request.query_params.get("error") == "selection" %}
<p>No messages selected.</p>
{% endif %}
{% if request.query_params.get("error") == "rule" %}
<p>No rules could be created from the selection.</p>
{% endif %}
{% if request.query_params.get("restored") %}
<p>Selected messages restored to inbox.</p>
{% endif %}
{% if request.query_params.get("deleted") %}
<p>Selected messages deleted.</p>
{% endif %}
{% if request.query_params.get("rules_created") %}
<p>Rule(s) created from selection.</p>
{% endif %}

<form method="get" action="/admin/quarantine" class="card" style="padding: 16px; margin-bottom: 20px;">
  <div style="display: grid; gap: 12px; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));">
    <div>
      <label for="domain_filter">Recipient domain</label>
      <input id="domain_filter" class="input" name="domain" type="text" value="{{ domain_filter }}" />
    </div>
    <div>
      <label for="sender_domain_filter">Sender domain</label>
      <input
        id="sender_domain_filter"
        class="input"
        name="sender_domain"
        type="text"
        value="{{ sender_domain_filter }}"
      />
    </div>
    <div>
      <label for="recipient_localpart_filter">Recipient local-part</label>
      <input
        id="recipient_localpart_filter"
        class="input"
        name="recipient_localpart"
        type="text"
        value="{{ recipient_localpart_filter }}"
      />
    </div>
    <div>
      <label for="start_date_filter">Start date</label>
      <input id="start_date_filter" class="input" name="start_date" type="date" value="{{ start_date_filter }}" />
    </div>
    <div>
      <label for="end_date_filter">End date</label>
      <input id="end_date_filter" class="input" name="end_date" type="date" value="{{ end_date_filter }}" />
    </div>
  </div>
  <div style="margin-top: 14px;">
    <button class="button" type="submit">Apply filters</button>
  </div>
</form>

<form method="post" action="/admin/quarantine/restore">
  <input type="hidden" name="domain" value="{{ domain_filter }}" />
  <input type="hidden" name="sender_domain" value="{{ sender_domain_filter }}" />
  <input type="hidden" name="recipient_localpart" value="{{ recipient_localpart_filter }}" />
  <input type="hidden" name="start_date" value="{{ start_date_filter }}" />
  <input type="hidden" name="end_date" value="{{ end_date_filter }}" />
  <div class="toolbar" style="margin-bottom: 16px; flex-wrap: wrap;">
    <div>
      <label for="admin_pin_quarantine">Admin PIN</label>
      <input id="admin_pin_quarantine" class="input" name="admin_pin" type="password" />
    </div>
    <div>
      <label for="match_field_quarantine">Rule match field</label>
      <select id="match_field_quarantine" class="input" name="match_field">
        {% for field in match_fields %}
        <option value="{{ field }}">{{ field }}</option>
        {% endfor %}
      </select>
    </div>
    <button class="button" type="submit">Restore</button>
    <button class="button secondary" type="submit" formaction="/admin/quarantine/delete">
      Delete
    </button>
    <button
      class="button secondary"
      type="submit"
      formaction="/admin/quarantine/rule-from-selection"
      name="rule_type"
      value="ALLOW"
    >
      Create ALLOW rule
    </button>
    <button
      class="button secondary"
      type="submit"
      formaction="/admin/quarantine/rule-from-selection"
      name="rule_type"
      value="BLOCK"
    >
      Create BLOCK rule
    </button>
  </div>

  <div class="card">
    <table class="table">
      <thead>
        <tr>
          <th>Recipient</th>
          <th>Sender</th>
          <th>Subject</th>
          <th>Quarantine reason</th>
          <th>Received</th>
        </tr>
      </thead>
      <tbody>
        {% if messages %}
        {% for message in messages %}
        <tr>
          <td>
            <input class="message-select" type="checkbox" name="message_id" value="{{ message.id }}" />
            <div>{{ message.envelope_rcpt }}</div>
          </td>
          <td>{{ message.from_addr or "Unknown" }}</td>
          <td>{{ message.subject or "(No subject)" }}</td>
          <td>{{ message.quarantine_reason or "â€”" }}</td>
          <td>{{ message.received_at }}</td>
        </tr>
        {% endfor %}
        {% else %}
        <tr>
          <td colspan="5">
            <div class="empty-state">No quarantined messages match the filters.</div>
          </td>
        </tr>
        {% endif %}
      </tbody>
    </table>
  </div>
</form>
{% endblock %}
