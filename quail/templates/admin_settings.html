{% extends "layout.html" %}
{% block content %}
<h1>Admin Settings</h1>
<p><a href="/admin/quarantine">View quarantine</a></p>
{% if request.query_params.get("updated") %}
<p>Settings updated.</p>
{% endif %}
{% if request.query_params.get("cleared") %}
<p>All messages deleted.</p>
{% endif %}
{% if request.query_params.get("error") == "retention" %}
<p>Retention must be a positive number.</p>
{% endif %}
{% if request.query_params.get("error") == "quarantine_retention" %}
<p>Quarantine retention must be a positive number.</p>
{% endif %}
{% if request.query_params.get("error") == "pin_length" %}
<p>Admin PIN must be 4-9 digits.</p>
{% endif %}
{% if request.query_params.get("error") == "pin_format" %}
<p>Admin PIN must contain digits only.</p>
{% endif %}
{% if request.query_params.get("domain_saved") %}
<p>Domain policy saved for {{ request.query_params.get("domain_saved") }}.</p>
{% endif %}
{% if request.query_params.get("domain_error") == "pin" %}
<p>Admin PIN verification is required for domain policy changes.</p>
{% endif %}
{% if request.query_params.get("domain_error") == "domain" %}
<p>Domain name is required to update a policy.</p>
{% endif %}
{% if request.query_params.get("domain_error") == "mode" %}
<p>Domain mode must be one of: {{ domain_modes | join(", ") }}.</p>
{% endif %}
{% if request.query_params.get("domain_error") == "action" %}
<p>Default action must be one of: {{ domain_actions | join(", ") }}.</p>
{% endif %}
{% if request.query_params.get("domain_error") == "retention" %}
<p>Quarantine retention override must be a positive number.</p>
{% endif %}
{% if request.query_params.get("rules_saved") %}
<p>Rule saved.</p>
{% endif %}
{% if request.query_params.get("rules_deleted") %}
<p>Rule deleted.</p>
{% endif %}
{% if request.query_params.get("rules_error") %}
<p>Rule error: {{ request.query_params.get("rules_error") }}</p>
{% endif %}
{% if request.query_params.get("rules_test") == "matched" %}
<p>Rule test matched.</p>
{% endif %}
{% if request.query_params.get("rules_test") == "no_match" %}
<p>Rule test did not match.</p>
{% endif %}
<form method="post" action="/admin/settings">
  <div>
    <label for="allowed_mime_types">Allowed attachment MIME types (comma-separated)</label>
    <input id="allowed_mime_types" name="allowed_mime_types" type="text" value="{{ allowed_mime_types }}" />
  </div>
  <div>
    <label for="retention_days">Retention days</label>
    <input id="retention_days" name="retention_days" type="number" min="1" value="{{ retention_days }}" />
  </div>
  <div>
    <label for="quarantine_retention_days">Quarantine retention days</label>
    <input
      id="quarantine_retention_days"
      name="quarantine_retention_days"
      type="number"
      min="1"
      value="{{ quarantine_retention_days }}"
    />
  </div>
  <div>
    <label for="allow_html">Allow HTML rendering (full)</label>
    <input id="allow_html" name="allow_html" type="checkbox" value="true" {% if allow_html %}checked{% endif %} />
  </div>
  <div>
    <label for="admin_pin">Update admin PIN (leave blank to keep)</label>
    <input
      id="admin_pin"
      name="admin_pin"
      type="password"
      inputmode="numeric"
      pattern="[0-9]*"
      minlength="4"
      maxlength="9"
    />
  </div>
  <button type="submit">Save settings</button>
</form>

<h2>Domain policies</h2>
<p>Changes apply only to new ingests.</p>
{% if domain_policies %}
  {% for policy in domain_policies %}
  <form method="post" action="/admin/domain-policies">
    <fieldset>
      <legend>{{ policy.domain }}</legend>
      <input type="hidden" name="domain" value="{{ policy.domain }}" />
      <div>
        <label for="mode_{{ loop.index }}">Mode</label>
        <select id="mode_{{ loop.index }}" name="mode">
          {% for mode in domain_modes %}
          <option value="{{ mode }}" {% if policy.mode == mode %}selected{% endif %}>{{ mode }}</option>
          {% endfor %}
        </select>
      </div>
      <div>
        <label for="action_{{ loop.index }}">Default action</label>
        <select id="action_{{ loop.index }}" name="default_action">
          {% for action in domain_actions %}
          <option value="{{ action }}" {% if policy.default_action == action %}selected{% endif %}>
            {{ action }}
          </option>
          {% endfor %}
        </select>
      </div>
      <div>
        <label for="retention_{{ loop.index }}">Quarantine retention override (days)</label>
        <input
          id="retention_{{ loop.index }}"
          name="quarantine_retention_days"
          type="number"
          min="1"
          value="{{ policy.quarantine_retention_days or '' }}"
        />
      </div>
      <div>
        <label>Last modified</label>
        <span>{{ policy.updated_at }}</span>
      </div>
      <div>
        <label for="pin_{{ loop.index }}">Admin PIN</label>
        <input
          id="pin_{{ loop.index }}"
          name="admin_pin"
          type="password"
          inputmode="numeric"
          pattern="[0-9]*"
          minlength="4"
          maxlength="9"
        />
      </div>
      <button type="submit">Save</button>
    </fieldset>
  </form>
  {% endfor %}
{% else %}
<p>No domain policies found yet. Add one below.</p>
{% endif %}

<h3>Add domain policy</h3>
<form method="post" action="/admin/domain-policies">
  <div>
    <label for="domain_policy_domain">Domain</label>
    <input id="domain_policy_domain" name="domain" type="text" />
  </div>
  <div>
    <label for="domain_policy_mode">Mode</label>
    <select id="domain_policy_mode" name="mode">
      {% for mode in domain_modes %}
      <option value="{{ mode }}">{{ mode }}</option>
      {% endfor %}
    </select>
  </div>
  <div>
    <label for="domain_policy_action">Default action</label>
    <select id="domain_policy_action" name="default_action">
      {% for action in domain_actions %}
      <option value="{{ action }}">{{ action }}</option>
      {% endfor %}
    </select>
  </div>
  <div>
    <label for="domain_policy_retention">Quarantine retention override (days)</label>
    <input id="domain_policy_retention" name="quarantine_retention_days" type="number" min="1" />
  </div>
  <div>
    <label for="domain_policy_pin">Admin PIN</label>
    <input
      id="domain_policy_pin"
      name="admin_pin"
      type="password"
      inputmode="numeric"
      pattern="[0-9]*"
      minlength="4"
      maxlength="9"
    />
  </div>
  <button type="submit">Save domain policy</button>
</form>

<h2>Address/content rules</h2>
<p>Manage allow/block rules for a domain. Changes apply only to new ingests.</p>
<form method="get" action="/admin/settings">
  <div>
    <label for="rules_domain">Domain</label>
    <input id="rules_domain" name="rules_domain" type="text" value="{{ rules_domain or '' }}" />
  </div>
  <button type="submit">Load rules</button>
</form>

{% if rules_domain %}
  {% if rules %}
  <table>
    <thead>
      <tr>
        <th>Enabled</th>
        <th>Type</th>
        <th>Match field</th>
        <th>Pattern</th>
        <th>Action</th>
        <th>Priority</th>
        <th>Note</th>
        <th>Last modified</th>
        <th>Admin PIN</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody>
    {% for rule in rules %}
      <form id="rule_form_{{ rule.id }}" method="post" action="/admin/rules/{{ rule.id }}"></form>
      <tr>
        <td>
          <input form="rule_form_{{ rule.id }}" type="hidden" name="enabled" value="0" />
          <input
            form="rule_form_{{ rule.id }}"
            type="checkbox"
            name="enabled"
            value="1"
            {% if rule.enabled %}checked{% endif %}
          />
        </td>
        <td>
          <select form="rule_form_{{ rule.id }}" name="rule_type">
            {% for rule_type in rule_types %}
            <option value="{{ rule_type }}" {% if rule.rule_type == rule_type %}selected{% endif %}>
              {{ rule_type }}
            </option>
            {% endfor %}
          </select>
        </td>
        <td>
          <select form="rule_form_{{ rule.id }}" name="match_field">
            {% for field in match_fields %}
            <option value="{{ field }}" {% if rule.match_field == field %}selected{% endif %}>
              {{ field }}
            </option>
            {% endfor %}
          </select>
        </td>
        <td>
          <input form="rule_form_{{ rule.id }}" name="pattern" type="text" value="{{ rule.pattern }}" />
        </td>
        <td>
          <select form="rule_form_{{ rule.id }}" name="action">
            {% for action in rule_actions %}
            <option value="{{ action }}" {% if rule.action == action %}selected{% endif %}>
              {{ action }}
            </option>
            {% endfor %}
          </select>
        </td>
        <td>
          <input
            form="rule_form_{{ rule.id }}"
            name="priority"
            type="number"
            min="0"
            value="{{ rule.priority }}"
          />
        </td>
        <td>
          <input form="rule_form_{{ rule.id }}" name="note" type="text" value="{{ rule.note or '' }}" />
        </td>
        <td>{{ rule.updated_at }}</td>
        <td>
          <input
            form="rule_form_{{ rule.id }}"
            name="admin_pin"
            type="password"
            inputmode="numeric"
            pattern="[0-9]*"
            minlength="4"
            maxlength="9"
          />
        </td>
        <td>
          <button form="rule_form_{{ rule.id }}" type="submit">Save</button>
          <button
            form="rule_form_{{ rule.id }}"
            type="submit"
            formaction="/admin/rules/{{ rule.id }}/delete"
          >
            Delete
          </button>
        </td>
      </tr>
    {% endfor %}
    </tbody>
  </table>
  {% else %}
  <p>No rules found for {{ rules_domain }}.</p>
  {% endif %}

  <h3>Add rule</h3>
  <form method="post" action="/admin/rules">
    <input type="hidden" name="domain" value="{{ rules_domain }}" />
    <div>
      <label for="rule_type_new">Type</label>
      <select id="rule_type_new" name="rule_type">
        {% for rule_type in rule_types %}
        <option value="{{ rule_type }}">{{ rule_type }}</option>
        {% endfor %}
      </select>
    </div>
    <div>
      <label for="match_field_new">Match field</label>
      <select id="match_field_new" name="match_field">
        {% for field in match_fields %}
        <option value="{{ field }}">{{ field }}</option>
        {% endfor %}
      </select>
    </div>
    <div>
      <label for="pattern_new">Pattern</label>
      <input id="pattern_new" name="pattern" type="text" />
    </div>
    <div>
      <label for="action_new">Action</label>
      <select id="action_new" name="action">
        {% for action in rule_actions %}
        <option value="{{ action }}">{{ action }}</option>
        {% endfor %}
      </select>
    </div>
    <div>
      <label for="priority_new">Priority</label>
      <input id="priority_new" name="priority" type="number" min="0" value="0" />
    </div>
    <div>
      <label for="note_new">Note</label>
      <input id="note_new" name="note" type="text" />
    </div>
    <div>
      <label for="enabled_new">Enabled</label>
      <input type="hidden" name="enabled" value="0" />
      <input id="enabled_new" name="enabled" type="checkbox" value="1" checked />
    </div>
    <div>
      <label for="admin_pin_new">Admin PIN</label>
      <input
        id="admin_pin_new"
        name="admin_pin"
        type="password"
        inputmode="numeric"
      pattern="[0-9]*"
        minlength="4"
        maxlength="9"
      />
    </div>
    <button type="submit">Add rule</button>
  </form>

  <h3>Test rule</h3>
  <form method="post" action="/admin/rules/test">
    <input type="hidden" name="rules_domain" value="{{ rules_domain }}" />
    <div>
      <label for="test_pattern">Pattern</label>
      <input id="test_pattern" name="pattern" type="text" />
    </div>
    <div>
      <label for="test_sample">Sample input</label>
      <input id="test_sample" name="sample" type="text" />
    </div>
    <div>
      <label for="admin_pin_test">Admin PIN</label>
      <input
        id="admin_pin_test"
        name="admin_pin"
        type="password"
        inputmode="numeric"
      pattern="[0-9]*"
        minlength="4"
        maxlength="9"
      />
    </div>
    <button type="submit">Test pattern</button>
  </form>
{% else %}
  <p>Load a domain to manage its rules.</p>
{% endif %}

<h2>Storage usage</h2>
<ul>
  <li>Total messages: {{ message_count }}</li>
  <li>Email storage: {{ message_bytes }}</li>
  <li>Attachment storage: {{ attachment_bytes }}</li>
  <li>Total storage: {{ total_bytes }}</li>
</ul>

<h2>Ingest metrics (last 24h)</h2>
<ul>
  <li>Inbox messages: {{ inbox_message_count }}</li>
  <li>Quarantine messages: {{ quarantine_message_count }}</li>
  <li>Dropped messages (last 24h): {{ dropped_message_count }}</li>
  <li>Ingest total (last 24h): {{ ingest_last_24h }}</li>
  <li>Recent ingest rate (messages/hour): {{ "%.2f" | format(recent_ingest_rate) }}</li>
</ul>
<h3>Top sender domains (last 24h)</h3>
{% if top_sender_domains %}
  <ul>
  {% for entry in top_sender_domains %}
    <li>{{ entry.domain }}: {{ entry.count }}</li>
  {% endfor %}
  </ul>
{% else %}
  <p>No sender domain data available yet.</p>
{% endif %}

<h2>Danger zone</h2>
<form method="post" action="/admin/messages/clear">
  <button type="submit" onclick="return confirm('Delete all messages and attachments?')">
    Delete all messages
  </button>
</form>
<p><a href="/inbox">Back to inbox</a></p>
{% endblock %}
