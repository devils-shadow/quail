{% extends "layout.html" %}
{% block content %}
<h1>Admin Settings</h1>
{% if request.query_params.get("updated") %}
<p>Settings updated.</p>
{% endif %}
{% if request.query_params.get("cleared") %}
<p>All messages deleted.</p>
{% endif %}
{% if request.query_params.get("error") == "retention" %}
<p>Retention must be a positive number.</p>
{% endif %}
{% if request.query_params.get("domain_saved") %}
<p>Domain policy saved for {{ request.query_params.get("domain_saved") }}.</p>
{% endif %}
{% if request.query_params.get("domain_error") == "pin" %}
<p>Admin PIN verification is required for domain policy changes.</p>
{% endif %}
{% if request.query_params.get("domain_error") == "domain" %}
<p>Domain name is required to update a policy.</p>
{% endif %}
{% if request.query_params.get("domain_error") == "mode" %}
<p>Domain mode must be one of: {{ domain_modes | join(", ") }}.</p>
{% endif %}
{% if request.query_params.get("domain_error") == "action" %}
<p>Default action must be one of: {{ domain_actions | join(", ") }}.</p>
{% endif %}
<form method="post" action="/admin/settings">
  <div>
    <label for="allowed_mime_types">Allowed attachment MIME types (comma-separated)</label>
    <input id="allowed_mime_types" name="allowed_mime_types" type="text" value="{{ allowed_mime_types }}" />
  </div>
  <div>
    <label for="retention_days">Retention days</label>
    <input id="retention_days" name="retention_days" type="number" min="1" value="{{ retention_days }}" />
  </div>
  <div>
    <label for="allow_html">Allow sanitized HTML rendering</label>
    <input id="allow_html" name="allow_html" type="checkbox" value="true" {% if allow_html %}checked{% endif %} />
  </div>
  <div>
    <label for="admin_pin">Update admin PIN (leave blank to keep)</label>
    <input id="admin_pin" name="admin_pin" type="password" />
  </div>
  <button type="submit">Save settings</button>
</form>

<h2>Domain policies</h2>
<p>Changes apply only to new ingests.</p>
{% if domain_policies %}
  {% for policy in domain_policies %}
  <form method="post" action="/admin/domain-policies">
    <fieldset>
      <legend>{{ policy.domain }}</legend>
      <input type="hidden" name="domain" value="{{ policy.domain }}" />
      <div>
        <label for="mode_{{ loop.index }}">Mode</label>
        <select id="mode_{{ loop.index }}" name="mode">
          {% for mode in domain_modes %}
          <option value="{{ mode }}" {% if policy.mode == mode %}selected{% endif %}>{{ mode }}</option>
          {% endfor %}
        </select>
      </div>
      <div>
        <label for="action_{{ loop.index }}">Default action</label>
        <select id="action_{{ loop.index }}" name="default_action">
          {% for action in domain_actions %}
          <option value="{{ action }}" {% if policy.default_action == action %}selected{% endif %}>
            {{ action }}
          </option>
          {% endfor %}
        </select>
      </div>
      <div>
        <label>Last modified</label>
        <span>{{ policy.updated_at }}</span>
      </div>
      <div>
        <label for="pin_{{ loop.index }}">Admin PIN</label>
        <input id="pin_{{ loop.index }}" name="admin_pin" type="password" />
      </div>
      <button type="submit">Save</button>
    </fieldset>
  </form>
  {% endfor %}
{% else %}
<p>No domain policies found yet. Add one below.</p>
{% endif %}

<h3>Add domain policy</h3>
<form method="post" action="/admin/domain-policies">
  <div>
    <label for="domain_policy_domain">Domain</label>
    <input id="domain_policy_domain" name="domain" type="text" />
  </div>
  <div>
    <label for="domain_policy_mode">Mode</label>
    <select id="domain_policy_mode" name="mode">
      {% for mode in domain_modes %}
      <option value="{{ mode }}">{{ mode }}</option>
      {% endfor %}
    </select>
  </div>
  <div>
    <label for="domain_policy_action">Default action</label>
    <select id="domain_policy_action" name="default_action">
      {% for action in domain_actions %}
      <option value="{{ action }}">{{ action }}</option>
      {% endfor %}
    </select>
  </div>
  <div>
    <label for="domain_policy_pin">Admin PIN</label>
    <input id="domain_policy_pin" name="admin_pin" type="password" />
  </div>
  <button type="submit">Save domain policy</button>
</form>

<h2>Storage usage</h2>
<ul>
  <li>Total messages: {{ message_count }}</li>
  <li>Email storage: {{ message_bytes }}</li>
  <li>Attachment storage: {{ attachment_bytes }}</li>
  <li>Total storage: {{ total_bytes }}</li>
</ul>

<h2>Danger zone</h2>
<form method="post" action="/admin/messages/clear">
  <button type="submit" onclick="return confirm('Delete all messages and attachments?')">
    Delete all messages
  </button>
</form>
<p><a href="/inbox">Back to inbox</a></p>
{% endblock %}
