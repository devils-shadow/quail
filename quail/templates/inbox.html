{% extends "layout.html" %}
{% block content %}
<div class="page-header">
  <h1 class="page-title">Public Messages</h1>
  <div class="toolbar">
    <form method="get" action="/inbox">
      <input
        class="input"
        type="text"
        name="inbox"
        value="{{ current_inbox | default('') }}"
        placeholder="Filter inbox (e.g. test or hamara*)"
      />
      <button class="button square" type="submit">GO</button>
    </form>
    <button class="button secondary icon" id="trash-button" type="button" aria-label="Delete messages">
      üóëÔ∏è
    </button>
    <button class="button secondary icon" id="pause-button" type="button" aria-label="Pause refresh">
      ‚è∏Ô∏è
    </button>
  </div>
</div>

<div class="card">
  <table class="table">
    <thead>
      <tr>
        <th>From</th>
        <th>Subject</th>
        <th>Received</th>
      </tr>
    </thead>
    <tbody>
      {% if messages %}
      {% set inbox_query = "" %}
      {% if current_inbox %}
      {% set inbox_query = "?inbox=" ~ (current_inbox | urlencode) %}
      {% endif %}
      {% for message in messages %}
      <tr data-message-id="{{ message.id }}">
        <td>
          <input class="message-select" type="checkbox" aria-label="Select message" />
          {{ message.from_addr or "Unknown" }}
          {% if is_admin and message.quarantined %}
          <span class="badge">Quarantined</span>
          {% endif %}
        </td>
        <td>
          <a href="/message/{{ message.id }}{{ inbox_query }}">
            {{ message.subject or "(No subject)" }}
          </a>
          <div class="row-muted">{{ message.envelope_rcpt }}</div>
        </td>
        <td>{{ message.received_at }}</td>
      </tr>
      {% endfor %}
      <tr data-empty-state style="display: none;">
        <td colspan="3">
          <div class="empty-state">This inbox is currently empty.</div>
        </td>
      </tr>
      {% else %}
      <tr data-empty-state>
        <td colspan="3">
          <div class="empty-state">This inbox is currently empty.</div>
        </td>
      </tr>
      {% endif %}
    </tbody>
  </table>
</div>
<script>
  const hiddenKey = "quailHiddenMessages";
  const pauseKey = "quailInboxPaused";
  const refreshIntervalMs = 3000;
  const inboxQuery =
    "{% if current_inbox %}?inbox={{ current_inbox | urlencode }}{% endif %}";
  const inboxApiUrl = `/api/inbox${inboxQuery}`;
  const isAdmin = {{ "true" if is_admin else "false" }};
  const tableBody = document.querySelector(".table tbody");
  let rows = Array.from(document.querySelectorAll("tr[data-message-id]"));
  let emptyRow = document.querySelector("[data-empty-state]");
  const trashButton = document.getElementById("trash-button");
  const pauseButton = document.getElementById("pause-button");
  let refreshTimer = null;
  let refreshInFlight = false;
  let lastEtag = null;

  const resetRows = () => {
    rows = Array.from(document.querySelectorAll("tr[data-message-id]"));
    emptyRow = document.querySelector("[data-empty-state]");
  };

  const readHidden = () => {
    try {
      const raw = window.sessionStorage.getItem(hiddenKey);
      const parsed = raw ? JSON.parse(raw) : [];
      return Array.isArray(parsed) ? parsed : [];
    } catch (error) {
      return [];
    }
  };

  const writeHidden = (items) => {
    try {
      window.sessionStorage.setItem(hiddenKey, JSON.stringify(items));
    } catch (error) {
      // Ignore storage errors.
    }
  };

  const updateEmptyState = () => {
    if (!emptyRow) {
      return;
    }
    const visibleRows = rows.filter((row) => !row.classList.contains("row-hidden"));
    emptyRow.style.display = visibleRows.length ? "none" : "table-row";
  };

  const applyHidden = () => {
    const hidden = new Set(readHidden());
    rows.forEach((row) => {
      const id = row.dataset.messageId;
      if (hidden.has(id)) {
        row.classList.add("row-hidden");
      }
    });
    updateEmptyState();
  };

  const buildEmptyRow = () => {
    const row = document.createElement("tr");
    row.dataset.emptyState = "true";
    const cell = document.createElement("td");
    cell.colSpan = 3;
    const emptyState = document.createElement("div");
    emptyState.className = "empty-state";
    emptyState.textContent = "This inbox is currently empty.";
    cell.appendChild(emptyState);
    row.appendChild(cell);
    return row;
  };

  const buildMessageRow = (message) => {
    const row = document.createElement("tr");
    row.dataset.messageId = message.id;

    const fromCell = document.createElement("td");
    const checkbox = document.createElement("input");
    checkbox.className = "message-select";
    checkbox.type = "checkbox";
    checkbox.setAttribute("aria-label", "Select message");
    fromCell.appendChild(checkbox);
    const fromText = document.createTextNode(
      ` ${message.from_addr || "Unknown"}`
    );
    fromCell.appendChild(fromText);
    if (isAdmin && message.quarantined) {
      const badge = document.createElement("span");
      badge.className = "badge";
      badge.textContent = "Quarantined";
      fromCell.appendChild(badge);
    }

    const subjectCell = document.createElement("td");
    const link = document.createElement("a");
    link.href = `/message/${message.id}${inboxQuery}`;
    link.textContent = message.subject || "(No subject)";
    subjectCell.appendChild(link);
    const muted = document.createElement("div");
    muted.className = "row-muted";
    muted.textContent = message.envelope_rcpt || "";
    subjectCell.appendChild(muted);

    const receivedCell = document.createElement("td");
    receivedCell.textContent = message.received_at || "";

    row.appendChild(fromCell);
    row.appendChild(subjectCell);
    row.appendChild(receivedCell);
    return row;
  };

  const renderMessages = (messages) => {
    if (!tableBody) {
      return;
    }
    const fragment = document.createDocumentFragment();
    messages.forEach((message) => {
      fragment.appendChild(buildMessageRow(message));
    });
    const emptyStateRow = buildEmptyRow();
    emptyStateRow.style.display = messages.length ? "none" : "table-row";
    fragment.appendChild(emptyStateRow);
    tableBody.replaceChildren(fragment);
    resetRows();
    applyHidden();
  };

  const hasSameMessages = (messages) => {
    if (rows.length !== messages.length) {
      return false;
    }
    return rows.every((row, index) => row.dataset.messageId == messages[index].id);
  };

  const refreshInbox = async () => {
    if (refreshInFlight || document.hidden) {
      return;
    }
    const isPaused = window.sessionStorage.getItem(pauseKey) === "true";
    if (isPaused) {
      return;
    }
    refreshInFlight = true;
    try {
      const headers = {};
      if (lastEtag) {
        headers["If-None-Match"] = lastEtag;
      }
      const response = await fetch(inboxApiUrl, { cache: "no-store", headers });
      if (response.status === 304) {
        return;
      }
      if (!response.ok) {
        return;
      }
      const nextEtag = response.headers.get("ETag");
      if (nextEtag) {
        lastEtag = nextEtag;
      }
      const payload = await response.json();
      if (!payload || !Array.isArray(payload.messages)) {
        return;
      }
      if (!hasSameMessages(payload.messages)) {
        renderMessages(payload.messages);
      }
    } catch (error) {
      // Ignore refresh errors.
    } finally {
      refreshInFlight = false;
    }
  };

  const updatePauseButton = () => {
    if (!pauseButton) {
      return;
    }
    const isPaused = window.sessionStorage.getItem(pauseKey) === "true";
    pauseButton.classList.toggle("paused", isPaused);
    pauseButton.setAttribute(
      "aria-label",
      isPaused ? "Resume refresh" : "Pause refresh"
    );
    pauseButton.setAttribute(
      "title",
      isPaused ? "Resume refresh (this session only)" : "Pause refresh (this session only)"
    );
  };

  if (trashButton) {
    trashButton.addEventListener("click", () => {
      const selected = rows.filter((row) =>
        row.querySelector(".message-select")?.checked
      );
      if (!selected.length) {
        return;
      }
      const hidden = new Set(readHidden());
      selected.forEach((row) => {
        const id = row.dataset.messageId;
        if (id) {
          hidden.add(id);
          row.classList.add("row-hidden");
        }
        const checkbox = row.querySelector(".message-select");
        if (checkbox) {
          checkbox.checked = false;
        }
      });
      writeHidden(Array.from(hidden));
      updateEmptyState();
    });
  }

  if (pauseButton) {
    pauseButton.addEventListener("click", () => {
      const isPaused = window.sessionStorage.getItem(pauseKey) === "true";
      window.sessionStorage.setItem(pauseKey, String(!isPaused));
      updatePauseButton();
    });
    updatePauseButton();
  }

  if (refreshIntervalMs > 0) {
    refreshTimer = window.setInterval(refreshInbox, refreshIntervalMs);
  }

  applyHidden();
</script>
{% endblock %}
